// prisma/schema.prisma

generator client {
  provider = "prisma-client"
  output   = "../src/infrastructure/database/generated/prisma"
}

datasource db {
  provider = "mysql"
}

//Tables---------------------------------------------------------------------
model Factor {
  id           Int          @id @default(autoincrement())
  factorNumber String       @unique
  status       FactorStatus @default(DRAFT)
  issuedAt     DateTime     @default(now())
  totalPrice   Float
  description  String?
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt

  customer   CustomerReference @relation(fields: [customerId], references: [id])
  customerId Int

  payment Payment?

  items FactorItem[]
}

model FactorItem {
  id          Int     @id @default(autoincrement())
  description String?
  quantity    Int     @default(1)
  unitPrice   Float
  totalPrice  Float
  serviceName String

  factor   Factor @relation(fields: [factorId], references: [id])
  factorId Int

  service   ServiceReference @relation(fields: [serviceId], references: [id])
  serviceId Int
}

model Payment {
  id            Int           @id @default(autoincrement())
  amount        Float
  method        PaymentMethod
  status        PaymentStatus @default(PENDING)
  transactionId String // From payment gateway (e.g., Stripe, PayPal)
  paidAt        DateTime?
  description   String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  factor   Factor @relation(fields: [factorId], references: [id])
  factorId Int    @unique
}

//Reference Tables--------------------------------------------------------
model CustomerReference {
  id           Int    @id
  firstName    String
  lastName     String
  nationalCode String
  mobile       String
  email        String

  factors Factor[]
}

model ServiceReference {
  id    Int    @id
  name  String
  price Float

  factorItems FactorItem[]
}

model InboxEvent {
  id          Int              @id @default(autoincrement())
  queue       String
  routingKey  String
  serviceName String
  status      InboxEventStatus @default(PENDING)
  captureAt   DateTime         @default(now())
  handledAt   DateTime?
  error       String?
  payload     Json
}

model OutboxEvent {
  id         Int               @id @default(autoincrement())
  routingKey String
  status     OutboxEventStatus @default(PENDING)
  captureAt  DateTime          @default(now())
  handledAt  DateTime?
  error      String?
  payload    Json
}

// Enums---------------------------------------------------------------
enum InboxEventStatus {
  PENDING
  Handled
  Error
}

enum OutboxEventStatus {
  PENDING
  Handled
  Error
}

enum FactorStatus {
  DRAFT
  ISSUED
  PAID
  PARTIALLY_PAID
  OVERDUE
  CANCELLED
}

enum PaymentMethod {
  CASH
  CREDIT_CARD
  BANK_TRANSFER
  ONLINE
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}
